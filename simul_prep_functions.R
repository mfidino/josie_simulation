
# functions to be used for simulation analysis

# structure

# 1 = utitlity functions for simulation
# 2 = mcmc summary functions
# 3 = convienience functions




#
#####
######
#1111111111111111111111111111111111111111111111111111111111111111111111111111111
#     utility functions   utility functionsutility functions utility functions
#1111111111111111111111111111111111111111111111111111111111111111111111111111111
######
#####
#

logit <- function(x) { 
  log(x/(1 - x))
}

expit <- function(x) {
  exp(x)/(1 + exp(x))
}


###############################################################################
###############################################################################
###############################################################################


###----------------------------------------------------------------------------
#     make_sim_df   make_sim_df   make_sim_df   make_sim_df   make_sim_df 
###----------------------------------------------------------------------------


make_sim_df <- function(nspec = NULL, nsite = NULL, nyear = NULL,
                        nrep = NULL, gam = NULL, phi = NULL,
                        p = NULL, gam_sd = NULL, phi_sd = NULL,
                        p_sd = NULL){
  if(missing(nspec)|missing(nsite)|missing(nyear)|missing(nrep)|
     missing(gam)|missing(phi)|missing(p)|missing(gam_sd)|missing(phi_sd)|
     missing(p_sd)){
    stop(c("\n\nSupply all arguments to this function (listed below).\n\n",
           args(make_sim_df)))
  }
  sim_df <- expand.grid(nspec, nsite, nyear, nrep, gam, phi, p, gam_sd,
                        phi_sd, p_sd)
  colnames(sim_df) <- c("nspec", "nsite", "nyear", "nrep", "gam",
                         "phi", "p", "gam_sd", "phi_sd", "p_sd")
  return(sim_df)
}



###----------------------------------------------------------------------------
#     gen_sim_list      gen_sim_list      gen_sim_list    gen_sim_list 
###----------------------------------------------------------------------------


gen_sim_list <- function(nsite = NULL, nspec = NULL, nyear = NULL,
                         nrep = NULL, actual_gam = NULL, sd_gam = NULL,
                         actual_phi = NULL, sd_phi = NULL,
                         actual_p = NULL, sd_p = NULL){
  
  # simulate gamma
  if(missing(actual_gam)) actual_gam <- rbeta(1, 1, 1)
  if(missing(sd_gam)) sd_gam <- runif(1, 1, 3)
  
  mu_gam <- logit(actual_gam)
  log_spec_gam <- rnorm(nspec, mu_gam, sd_gam)
  gam <- expit(log_spec_gam)
  
  # simulate phi
  if(missing(actual_phi)) actual_phi <- rbeta(1, 1, 1)
  if(missing(sd_phi)) sd_phi <- runif(1, 1, 3)
  
  mu_phi <- logit(actual_phi)
  log_spec_phi <- rnorm(nspec, mu_phi, sd_phi)
  phi <- expit(log_spec_phi)
  
  # simulate p
  
  if(missing(actual_p)) actual_p <- runif(1, .1, .3) # keeping it low, because camera traps
  if(missing(sd_p)) sd_p <- runif(1, 0, 3)
  
  mu_p <- logit(actual_p)
  log_spec_p <- rnorm(nspec, mu_p, sd_p)
  p <- expit(log_spec_p)
  
  sim_list <- list(nsite = nsite,
                   nspec = nspec,
                   nyear = nyear,
                   nrep = nrep,
                   gam = gam,
                   phi = phi,
                   p = p,
                   hyperp_sd = list(gam = sd_gam,
                                 phi = sd_phi,
                                 p = sd_p),
                   hyperp_mean = list(gam = actual_gam,
                                 phi = actual_phi,
                                 p = actual_p)
                   )
  
  return(sim_list)
}



###############################################################################
###############################################################################
###############################################################################


###----------------------------------------------------------------------------
#     sim_z   sim_z   sim_z   sim_z   sim_z   sim_z   sim_z   sim_z   sim_z  
###----------------------------------------------------------------------------


sim_z <- function(sim_list = NULL){
  with(sim_list,{
  # initial occupancy states
  # makes a nsite * species matrix for the first season z0
  phi0 <- runif(nspec, .1, .9)
  z0 <- array(dim = c(nsite, nspec))
  for (i in 1:nspec) {
    z0[, i] <- rbinom(nsite, 1, phi0[i])
  }
  # subsequent occupancy
  # makes a nsite by species by year for the following years
  z <- array(dim = c(nspec, nsite, nyear))
  lpsi <- array(dim = c(nspec, nsite, nyear))
  psi <- array(dim = c(nspec, nsite, nyear))
  
  for(t in 1:nyear) {
    for (k in 1:nsite) {
      for (i in 1:nspec) {
        
        if (t == 1) { #lpsi = logit of psi
          # just add together colonization
          lgam <- (1 - z0[k, i])* (logit(gam[i])) #not expit gamma!
          # just add together persistence  
          lphi <-  z0[k, i] * (logit(phi[i]))
          # put both of them together in the lpsi matrix  
          lpsi[i, k, 1] <- lgam + lphi
          # expit of logit of psi
          psi[i, k, 1] <- expit(lpsi[i, k, 1])
          z[i, k, 1] <- rbinom(1, 1, psi[i, k, 1])
        } else {
          lgam <- (1 - z[i, k, t-1])* (gam[i])
          lphi <- z[i, k, t - 1] * (phi[i])
          lpsi[i, k, t] <- lgam + lphi
          psi[i, k, t] <- expit(lpsi[i, k, t])
          z[i, k, t] <- rbinom(1, 1, psi[i, k, t])
        }
      }
    }
  }

  return(z) 
  })
  
}


###############################################################################
###############################################################################
###############################################################################




###----------------------------------------------------------------------------
#     sim_jmat    sim_jmat    sim_jmat    sim_jmat    sim_jmat    sim_jmat
###----------------------------------------------------------------------------

sim_jmat <- function(sim_list = NULL, add_NA = TRUE){
  with(sim_list, {
    jmat <- array(0, dim = c(nspec, nsite, nyear))
      for(k in 1:nsite){
        for(t in 1:nyear){
          jmat[,k,t] <- floor(rnorm(1, 18, 2.5))
        }}
    jmat[jmat>nrep] <- nrep # or less than 0
    jmat[jmat<0] <- 0
    
    if(add_NA == TRUE){
      years <- unique(ceiling(runif(5, 1, nyear)))
      for(i in 1:length(years)){
        sites <- floor(runif(15, 1, nsite))
        jmat[,sites,years[i]] <- NA
      }
    }
    return(jmat)
    
  })
}


###############################################################################
###############################################################################
###############################################################################


###----------------------------------------------------------------------------
#     sim_ymat    sim_ymat    sim_ymat    sim_ymat    sim_ymat    sim_ymat
###----------------------------------------------------------------------------

sim_ymat <- function(sim_list = NULL, jmat = jmat, z = z){
  
  with(sim_list, {
    ymat <- array(dim = c(nspec, nsite, nyear))
    for(i in 1:nspec){
      for(k in 1:nsite){
        for(t in 1:nyear){
          if(is.na(jmat[i,k,t])==TRUE){
            ymat[i,k,t] <- NA
          }else{
          ymat[i,k,t] <- rbinom(1, jmat[i, k, t], p[i] * z[i, k, t])
          } # end else
        } # end t
      } # end j
    } # end i
    
    return(ymat)
    
  })
}

###############################################################################
###############################################################################
###############################################################################



###----------------------------------------------------------------------------
#     make_zinit      make_zinit    make_zinit    make_zinit    make_zinit
###----------------------------------------------------------------------------

make_zinit <- function(ymat = NULL){
  zinit <- ymat

  zinit[zinit>0] <- 1
  return(zinit)

}

###############################################################################
###############################################################################
###############################################################################

###----------------------------------------------------------------------------
#     sim_matrices sim_matrices sim_matrices sim_matrices sim_matrices 
###----------------------------------------------------------------------------


sim_matrices <- function(sim_list, add_NA = TRUE){
  z <- sim_z(sim_list)
  jmat <- sim_jmat(sim_list, add_NA = add_NA)
  ymat <- sim_ymat(sim_list, jmat, z)
  zinit <- make_zinit(ymat)
  
  the_mats <- list(z = z,
                   jmat = jmat,
                   ymat = ymat,
                   zinit = zinit)
  return(the_mats)
}

###############################################################################
###############################################################################
###############################################################################

###----------------------------------------------------------------------------
#     sim_all   sim_all   sim_all   sim_all   sim_all   sim_all
###----------------------------------------------------------------------------

sim_all <- function(nsite = NULL, nspec = NULL, nyear = NULL, nrep = NULL,
                    add_NA = TRUE, actual_gam = NULL, sd_gam = NULL,
                    actual_phi = NULL, sd_phi = NULL,
                    actual_p = NULL, sd_p = NULL){
  sim_list <- gen_sim_list(nsite = nsite, nspec = nspec,
                          nyear = nyear, nrep = nrep, actual_gam = actual_gam,
                          sd_gam = sd_gam, actual_phi = actual_phi,
                          sd_phi = sd_phi, actual_p = actual_p,
                          sd_p = sd_p)
  mats <- sim_matrices(sim_list = sim_list, add_NA = add_NA)
  
  mats$jmat[which(is.na(mats$jmat)==TRUE)] <- 0
  
  data_list <- list(y = mats$ymat, nsite = nsite, nyear = nyear,
                    nspec = nspec, jmat = mats$jmat)
  
  

  
  sims <- list(sim_list = sim_list,
               mats = mats,
               data_list = data_list)
  
  
  return(sims)
}

###############################################################################
###############################################################################
###############################################################################



#
#####
######
#222222222222222222222222222222222222222222222222222222222222222222222222222222
# MCMC summary functions    MCMC summary functions    MCMC summary functions
#222222222222222222222222222222222222222222222222222222222222222222222222222222
######
#####
#


###----------------------------------------------------------------------------
#     grab_msd    grab_msd    grab_msd    grab_msd    grab_msd    grab_msd
###----------------------------------------------------------------------------


grab_msd <- function(data = NULL){
  stat <- data$statistics
  ans <- array(0, dim = c(nrow(stat), 2))
  for(i in 1:nrow(stat)){
    ans[i,] <- stat[i, 1:2]
  }
  rownames(ans) <- rownames(stat)
  colnames(ans) <- colnames(stat[,1:2])
  return(ans)
}



###############################################################################
###############################################################################
###############################################################################


###----------------------------------------------------------------------------
#     grab_quant    grab_quant    grab_quant    grab_quant    grab_quant
###----------------------------------------------------------------------------

grab_quant <- function(data = NULL){
  quant <- data$quantiles
  ans <- array(0, dim = c(nrow(quant), 2))
  for(i in 1:nrow(quant)){
    ans[i,] <- quant[i, c(1,5)]
  }
  rownames(ans) <- rownames(quant)
  colnames(ans) <- colnames(quant)[c(1,5)]
  return(ans)
}



###############################################################################
###############################################################################
###############################################################################




###----------------------------------------------------------------------------
#     pull_summary    pull_summary    pull_summary    pull_summary
###----------------------------------------------------------------------------

pull_summary <- function(data){
  step_one <- grab_msd(data)
  step_two <- grab_quant(data)
  return(signif(cbind(step_one, step_two), 3))
}

###############################################################################
###############################################################################
###############################################################################


#
#####
######
#333333333333333333333333333333333333333333333333333333333333333333333333333333
# Convienience functions    Convienience functions    Convienience functions
#333333333333333333333333333333333333333333333333333333333333333333333333333333
######
#####
#




###----------------------------------------------------------------------------
#     array_2_df    array_2_df    array_2_df    array_2_df    array_2_df
###----------------------------------------------------------------------------

array_2_df <- function(my_array = NULL){
  require(plyr)
  if(length(dim(my_array)) != 3){
    stop("Error: You did not give this function a 3-dimensional array.")
  }
  
  my_df <- adply(my_array, c(1,2,3))
  colnames(my_df) <- c("species", "site", "season", "count")
  return(my_df)
  
}

###############################################################################
###############################################################################
###############################################################################



###----------------------------------------------------------------------------
#     df_2_array    df_2_array    df_2_array    df_2_array    df_2_array
###----------------------------------------------------------------------------

df_2_array <- function(my_df = NULL){
  require(reshape2)
  my_array <- acast(my_df, species~site~season, value.var = "count")
  dimnames(my_array) <- NULL
  return(my_array)
}


###############################################################################
###############################################################################
###############################################################################




